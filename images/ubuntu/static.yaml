# Builds a "distroless" image based on ubuntu:jammy
#
# "static" is a image that can be used to package statically built binaries (go, rust, etc)

build:
  from:
    type: docker
    url: docker://ubuntu:jammy
  run: |
    apt-get update && apt-get dist-upgrade -y
    dldir=$(mktemp -d ${TMPDIR:-/tmp}/XXXXXX)
    apt-get -y --reinstall install \
        "--option=Dir::Cache::Archives=$dldir" \
        --download-only \
        ca-certificates base-files netbase tzdata
    ls $dldir
    mkdir rootfs
    dpkg-deb -xv $dldir/ca-certificates*.deb rootfs
    dpkg-deb -xv $dldir/base-files*.deb rootfs
    dpkg-deb -xv $dldir/netbase*.deb rootfs
    dpkg-deb -xv $dldir/tzdata*.deb rootfs
    # post-build cleanup
    rm -rf rootfs/usr/bin/*
    rm -rf rootfs/usr/sbin/*
    rm -rf rootfs/usr/share/doc/*
    rm -rf rootfs/usr/share/man/*
    # post-build packaging
    cd rootfs/
    tar cpvf /rootfs.tar .
    ls -altr /rootfs.tar
    sha256sum /rootfs.tar
  build_only: true

static:
  from:
    type: tar
    url: stacker://build/rootfs.tar
